<div id="vue-traq"></div>
<?= ui_package('traq') ?>

<div id="ticket_history">
	<h3><?php echo l('ticket_history'); ?></h3>
	<?php foreach ($ticket_history as $update) { ?>
		<div class="update" id="ticket_update_<?php echo $update->id; ?>">
			<h4>
				<?php echo l('x_by_x', time_ago($update->created_at), HTML::link(strshorten($update->user->name, 20), $update->user->href())); ?>
				<?php
				if ($current_user->permission($ticket->project_id, 'edit_ticket_history')) {
					echo HTML::link('', $ticket->href("/history/{$update->id}/edit"), array('title' => l('edit'), 'class' => 'button_edit', 'data-overlay' => true));
				}
				if ($current_user->permission($ticket->project_id, 'delete_ticket_history')) {
					echo HTML::link('', $ticket->href("/history/{$update->id}/delete"), array('title' => l('delete'), 'class' => 'button_delete', 'data-ajax-confirm' => l('confirm.delete')));
				}
				?>
			</h4>
			<?php if (is_array($update->changes)) { ?>
				<ul class="changes">
					<?php foreach ($update->changes as $change) { ?>
						<li><?php echo View::render('tickets/_history_change_bit', array('change' => $change)); ?></li>
					<?php } ?>
				</ul>
			<?php } ?>
			<?php if ($update->comment != '') { ?>
				<div class="comment">
					<?php echo format_text($update->comment); ?>
				</div>
			<?php } ?>
		</div>
	<?php } ?>
</div>
<?php echo View::render('tickets/_update_ticket_form'); ?>
