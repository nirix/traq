<?php extendView('layouts/default.phtml'); ?>

<div class="profile content">
	<h2 class="page-title"><?= l('xs_profile', $profile->name) ?></h2>

	<div class="flex">
		<div class="w-[400px]">
			<div class="panel">
				<div class="panel-content">
					<h3><?= l('information'); ?></h3>
					<dl>
						<dt><?= l('group'); ?></dt>
						<dd><?= $profile->group->name; ?></dd>

						<dt><?= l('assigned_tickets'); ?></dt>
						<dd><?= $profile->assigned_tickets->exec()->row_count(); ?></dd>

						<dt><?= l('tickets_created'); ?></dt>
						<dd><?= $profile->tickets->exec()->row_count(); ?></dd>

						<dt><?= l('ticket_updates'); ?></dt>
						<dd><?= $profile->ticket_updates->exec()->row_count(); ?></dd>

						<dt><?= l('member_since'); ?></dt>
						<dd><?= ($profile->created_at ? ldate(settings('date_format')) : l('unknown')); ?></dd>
						<?php FishHook::run('template:users/users/view', array($profile)); ?>
					</dl>
				</div>
			</div>

			<?php if (count($memberships)) : ?>
				<div class="panel mt-4">
					<div class="panel-content">
						<h3><?= l('projects'); ?></h3>
						<ul class="mb-0">
							<?php foreach ($memberships as $membership) : ?>
								<?php if (currentUser()->permission($membership->project->id, 'view')) : ?>
									<li>
										<a href="<?= Request::base($membership->project->href()) ?>"><?= $membership->project->name ?></a>, <?= $membership->role->name ?>
									</li>
								<?php endif; ?>
							<?php endforeach; ?>
						</ul>
					</div>
				</div>
			<?php endif; ?>
		</div>

		<div class="ml-4 w-full">
			<?php if (count($memberships)) { ?>
				<div id="assigned_to">
					<h3><?= l('assigned_tickets'); ?></h3>

					<?php foreach ($memberships as $membership) : ?>
						<div class="panel" x-data="{ open: true }">
							<div class="panel-title" @click="open = !open">
								<h3><?= l($membership->project->name); ?></h3>
								<i class="fa-solid fa-chevron-down" x-show="!open"></i>
								<i class="fa-solid fa-chevron-up" x-show="open"></i>
							</div>
							<div x-show="open" x-transition>
								<?php if (isset($assignedTickets[$membership->project_id]) && count($assignedTickets[$membership->project_id])) : ?>
									<table>
										<thead>
											<th class="id"><?= l('id'); ?></th>
											<th class="summary"><?= l('summary'); ?></th>
											<th class="status"><?= l('status'); ?></th>
											<th class="type"><?= l('type'); ?></th>
											<th class="milestone"><?= l('milestone'); ?></th>
											<th class="component"><?= l('component'); ?></th>
										</thead>
										<tbody>
											<?php foreach ($assignedTickets[$membership->project_id] as $ticket) {
											?>
												<tr>
													<td><?= $ticket->ticket_id; ?></td>
													<td>
														<a href="<?= Request::base($ticket->href()) ?>"><?= $ticket->summary; ?></a>
													</td>
													<td><?= $ticket->status->name; ?></td>
													<td><?= $ticket->type->name; ?></td>
													<td><?= $ticket->milestone ? $ticket->milestone->name : '-'; ?></td>
													<td><?= $ticket->component ? $ticket->component->name : '-'; ?></td>
												</tr>
											<?php } ?>
										</tbody>
									</table>
								<?php else : ?>
									<div class="panel-content"><?= l('no_tickets_assigned'); ?></div>
								<?php endif; ?>
							</div>
						</div>
					<?php endforeach; ?>
				</div>
			<?php } ?>
		</div>
	</div>
</div>
